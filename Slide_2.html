<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOS Narva</title>

  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="sos-page">


<div class="sos-sidebar" id="sidebar">
  <h4>Меню</h4>
  <a href="Provider_Reg_1.html">Регистрация поставщика услуг</a>
  <a href="#">Личный кабинет</a>
  <a href="#">Настройки</a>
  <a href="#">Условия пользования</a>
  <a href="#">Правила безопасности</a>
  <a href="#">Как начать работать</a>
  <a href="#">— для юр. лиц</a>
  <a href="#">— для физ. лиц</a>
  <a href="#">Контакты</a>
</div>
<div class="sos-overlay" id="overlay"></div>

<div class="phone-frame">

  
  <div class="sos-header">
    <a href="index.html" class="sos-logo">SOS Narva</a>
    <button class="sos-menu-btn" id="menuBtn">
      <svg class="sos-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 12h16M4 18h6"/>
      </svg>
    </button>
  </div>

  
  <div class="sos-form-group">
    <label class="sos-form-label">Марка автомобиля</label>
    <input class="sos-form-input" value="Volvo">
  </div>

  <div class="sos-form-group">
    <label class="sos-form-label">Модель</label>
    <input class="sos-form-input" value="X70">
  </div>

  <div class="sos-form-group">
    <label class="sos-form-label">Регистрационный номер</label>
    <input class="sos-form-input" value="123 ADC">
  </div>

  <div class="sos-form-group">
    <label class="sos-form-label">Ваше местоположение</label>
    <div id="map" class="sos-map"></div>
    <div id="coordinates" class="sos-coordinates">
      Определяем местоположение...
    </div>
  </div>

  <div class="sos-check-line">
    <input type="checkbox">
    Подтвердите ваше местоположение
  </div>

  <div class="sos-form-group">
    <div style="position: relative;">
      <span class="sos-pay-icon" style="left: 12px; top: 50%; transform: translateY(-50%); position: absolute;">
        <svg width="16" height="16" fill="none" stroke="red" viewBox="0 0 24 24">
          <rect x="1" y="4" width="22" height="16" rx="2" stroke-width="2"/>
          <line x1="1" y1="10" x2="23" y2="10" stroke-width="2"/>
        </svg>
      </span>
  
      <select class="sos-form-select sos-pay-select" onchange="goPay(this)" style="padding-left: 36px;">
        <option disabled selected>Способ оплаты</option>
        <option value="registration.html">Оплата на месте наличными (+15%)</option>
        <option value="registration.html">Оплата на месте картой (-10%)</option>
        <option value="registration.html">Оплата на подписке (-25%)</option>
      </select>
    </div>
  </div>
  
  
  
  

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const menuBtn = document.getElementById("menuBtn");

  menuBtn.onclick = () => {
    sidebar.classList.add("active");
    overlay.classList.add("active");
  };

  overlay.onclick = () => {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  };

  
  let map, marker;

  async function getAddress(lat, lon) {
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18`,
        { headers: { "User-Agent": "SOS-Narva-App" } }
      );
      const data = await res.json();
      const text = data?.display_name || `Место: ${lat}, ${lon}`;
      document.getElementById("coordinates").innerText = text;
      
      const orderState = JSON.parse(localStorage.getItem("orderState") || "{}");
      orderState.address = text;
      localStorage.setItem("orderState", JSON.stringify(orderState));
    } catch {
      const fallback = `Место: ${lat}, ${lon}`;
      document.getElementById("coordinates").innerText = fallback;
      const orderState = JSON.parse(localStorage.getItem("orderState") || "{}");
      orderState.address = fallback;
      localStorage.setItem("orderState", JSON.stringify(orderState));
    }
  }

  function initMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    marker = L.marker([lat, lon]).addTo(map);
    getAddress(lat, lon);

    map.on("click", e => {
      const newLat = e.latlng.lat.toFixed(5);
      const newLon = e.latlng.lng.toFixed(5);
      marker.setLatLng([newLat, newLon]);
      getAddress(newLat, newLon);
    });
  }

  function showPosition(pos) {
    initMap(
      pos.coords.latitude.toFixed(5),
      pos.coords.longitude.toFixed(5)
    );
  }

  function showError() {
    document.getElementById("coordinates").innerText =
      "Не получается получить ваше местоположение";

    map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  }

  navigator.geolocation
    ? navigator.geolocation.getCurrentPosition(showPosition, showError)
    : showError();

  function goPay(select) {
    if (select.value) location.href = select.value;
  }
</script>

</body>
</html>
